name: CI

on:
  push:
    branches: ["main", "develop", "claude/**"]
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch:  # Allow manual trigger

jobs:
  ci:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for auto-committing requirements.txt

    steps:
      # ======================================================================
      # Setup
      # ======================================================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 libsqlite3-dev

      # ======================================================================
      # Install Dependencies with uv
      # ======================================================================
      - name: Install dependencies
        run: uv sync --all-extras

      # ======================================================================
      # Code Quality Checks (continue-on-error to run all checks)
      # ======================================================================
      - name: Run ruff linter
        id: ruff-check
        continue-on-error: true
        run: |
          echo "ğŸ” Running ruff linter..."
          uv run ruff check . 2>&1 | tee ruff-check.log
          exit ${PIPESTATUS[0]}

      - name: Run ruff formatter check
        id: ruff-format
        continue-on-error: true
        run: |
          echo "ğŸ¨ Checking code formatting..."
          uv run ruff format --check . 2>&1 | tee ruff-format.log
          exit ${PIPESTATUS[0]}

      - name: Run mypy type checker
        id: mypy
        continue-on-error: true
        run: |
          echo "ğŸ” Running mypy type checker..."
          uv run mypy src --no-error-summary 2>&1 | tee mypy.log
          exit ${PIPESTATUS[0]}

      - name: Run pytest
        id: pytest
        continue-on-error: true
        run: |
          echo "ğŸ§ª Running pytest..."
          uv run pytest -v --tb=short --cov=src --cov-report=term-missing 2>&1 | tee pytest.log
          exit ${PIPESTATUS[0]}

      # ======================================================================
      # Artifact Upload (Save logs for debugging)
      # ======================================================================
      - name: Upload test logs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: |
            ruff-check.log
            ruff-format.log
            mypy.log
            pytest.log
            htmlcov/
          retention-days: 7

      # ======================================================================
      # Final Status Check
      # ======================================================================
      - name: Check if any step failed
        if: |
          steps.ruff-check.outcome == 'failure' ||
          steps.ruff-format.outcome == 'failure' ||
          steps.mypy.outcome == 'failure' ||
          steps.pytest.outcome == 'failure'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ CI CHECKS FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Failed checks:"
          [[ "${{ steps.ruff-check.outcome }}" == "failure" ]] && echo "  â€¢ Ruff linter"
          [[ "${{ steps.ruff-format.outcome }}" == "failure" ]] && echo "  â€¢ Ruff formatter"
          [[ "${{ steps.mypy.outcome }}" == "failure" ]] && echo "  â€¢ Mypy type checker"
          [[ "${{ steps.pytest.outcome }}" == "failure" ]] && echo "  â€¢ Pytest"
          echo ""
          echo "ğŸ“¥ Download artifacts for detailed logs"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1

      - name: Success message
        if: |
          steps.ruff-check.outcome == 'success' &&
          steps.ruff-format.outcome == 'success' &&
          steps.mypy.outcome == 'success' &&
          steps.pytest.outcome == 'success'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ALL CI CHECKS PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
